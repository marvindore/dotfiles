-- Pull in the wezterm API
local wezterm = require("wezterm")
local act = wezterm.action
local mux = wezterm.mux
local is_linux = function()
	return wezterm.target_triple:find("linux") ~= nil
end

local is_darwin = function()
	return wezterm.target_triple:find("darwin") ~= nil
end

-- windows path
local zoxide_path = ""

if is_darwin() then
  zoxide_path = "/opt/homebrew/bin/zoxide"
end

if is_linux() then
  zoxide_path = "/usr/bin/zoxide"
end

-- Initialize Resurrect Plugin
local resurrect = wezterm.plugin.require("https://github.com/MLFlexer/resurrect.wezterm")

-- auto load last session on startup
wezterm.on("gui-startup", resurrect.state_manager.resurrect_on_gui_startup)


wezterm.on("gui-startup", function(cmd)
	local tab, pane, window = mux.spawn_window(cmd or {})
	window:gui_window():maximize()
end)

-- print workspace name at the upper right
wezterm.on("update-right-status", function(window, pane)
  window:set_right_status(window:active_workspace())
end)
-- load plugin
local workspace_switcher = wezterm.plugin.require("https://github.com/MLFlexer/smart_workspace_switcher.wezterm")
-- set path to zoxide
workspace_switcher.zoxide_path = zoxide_path


local config = {}
-- In newer versions of wezterm, use the config_builder which will
-- help provide clearer error messages
if wezterm.config_builder then
	config = wezterm.config_builder()
end

config.max_fps = 120

config.window_decorations = "TITLE|RESIZE|MACOS_FORCE_DISABLE_SHADOW"

-- This is where you actually apply your config choices
config.default_cursor_style = "BlinkingBar"
config.font = wezterm.font_with_fallback({ "JetBrains Mono", "Fira Code" })
config.warn_about_missing_glyphs = false
config.font_size = 15

-- config.default_domain = 'WSL:Ubuntu'
if os.getenv("OS") == "Windows_NT" then
	config.default_prog = { "pwsh.exe" }
  -- config.default_domain = 'WSL:Ubuntu'
end
--config.default_prog = { "/opt/homebrew/bin/nu" }
config.color_scheme = "MaterialDarker"
-- tmux
--if is_darwin() then
--else
--end

config.leader = { key = "Space", mods = "CTRL", timeout_milliseconds = 2000 }

config.keys = {
  --------------------------------------------------
  ---Pane Naviation & Splits
  --------------------------------------------------
	-- tmux defaults
	{ mods = "LEADER", key = "v", action = wezterm.action.SplitHorizontal({ domain = "CurrentPaneDomain" }) },
	{ mods = "LEADER", key = "h", action = wezterm.action.SplitVertical({ domain = "CurrentPaneDomain" }) },
	{ mods = "LEADER", key = "c", action = wezterm.action.SpawnTab("CurrentPaneDomain") },
	{ mods = "LEADER", key = "x", action = wezterm.action.CloseCurrentPane({ confirm = true }) },
	{ mods = "SHIFT", key = "LeftArrow", action = wezterm.action.ActivateTabRelative(-1) },
	{ mods = "SHIFT", key = "RightArrow", action = wezterm.action.ActivateTabRelative(1) },
	{ mods = "CTRL", key = "h", action = wezterm.action.ActivatePaneDirection("Left") },
	{ mods = "CTRL", key = "j", action = wezterm.action.ActivatePaneDirection("Down") },
	{ mods = "CTRL", key = "k", action = wezterm.action.ActivatePaneDirection("Up") },
	{ mods = "CTRL", key = "l", action = wezterm.action.ActivatePaneDirection("Right") },
	{ mods = "LEADER", key = "LeftArrow", action = wezterm.action.AdjustPaneSize({ "Left", 5 }) },
	{ mods = "LEADER", key = "RightArrow", action = wezterm.action.AdjustPaneSize({ "Right", 5 }) },
	{ mods = "LEADER", key = "DownArrow", action = wezterm.action.AdjustPaneSize({ "Down", 5 }) },
	{ mods = "LEADER", key = "UpArrow", action = wezterm.action.AdjustPaneSize({ "Up", 5 }) },
  { mods = "LEADER", key = "Space", action = wezterm.action.RotatePanes "Clockwise" },
  { mods = "LEADER", key = "0", action = wezterm.action.PaneSelect { mode = "SwapWithActive" }},

  --------------------------------------------------
  ---Session / Workspace Management
  --------------------------------------------------
  { mods = "LEADER", key = "w", action = act.ShowLauncherArgs { flags = 'FUZZY|WORKSPACES'}},
  { mods = "CTRL|SHIFT", key = "s", action = workspace_switcher.switch_workspace()},
  { mods = "CTRL|SHIFT", key = "[", action = act.SwitchWorkspaceRelative(1)},
  { mods = "CTRL|SHIFT", key = "]", action = act.SwitchWorkspaceRelative(-1)},
	-- paste from clipboard
	{ key = "V", mods = "CTRL", action = act.PasteFrom("Clipboard") },
	-- paste from primary selection
	{ key = "V", mods = "CTRL", action = act.PasteFrom("PrimarySelection") },
	-- close window
  { key = "w", mods = "CTRL", action = act.CloseCurrentPane { confirm = false }},
-- Save State
  { 
    mods = "LEADER", 
    key = "S", 
    action = wezterm.action_callback(function(win, pane)
      resurrect.save_state(resurrect.workspace_state.get_workspace_state())
    end) 
  },
  
  -- Restore State (using the fuzzy loader)
  { 
    mods = "LEADER", 
    key = "R", 
    action = wezterm.action_callback(function(win, pane)
      resurrect.fuzzy_load(win, pane, function(id, label)
        local type = string.match(id, "^([^/]+)") -- match before '/'
        id = string.match(id, "([^/]+)$") -- match after '/'
        id = string.match(id, "(.-)%.json$") -- remove extension
        local state = resurrect.load_state(id, type)
        
        local opts = {
          relative = true,
          restore_text = true,
          on_pane_restore = resurrect.tab_state.default_on_pane_restore,
        }
        
        if type == "workspace" then
          opts.window = win:mux_window()
          resurrect.workspace_state.restore_workspace(state, opts)
        elseif type == "window" then
          resurrect.window_state.restore_window(pane:window(), state, opts)
        elseif type == "tab" then
          resurrect.tab_state.restore_tab(pane:tab(), state, opts)
        end
      end)
    end) 
  },

  --------------------------------------------------
  ---Custom
  --------------------------------------------------
  -- neovim config
  { 
    mods = "LEADER", 
    key = "n", 
    action = act.SwitchToWorkspace {
      name = 'config',
      spawn = {
        args = {
-- Launch your default shell (e.g., zsh or bash) and tell it to run nvim
          os.getenv("SHELL") or "bash", "-c", "nvim " .. wezterm.home_dir .. "/.config"
        },
      },
    }
  },
}

for i = 0, 9 do
	table.insert(config.keys, {
		key = tostring(i),
		mods = "LEADER",
		action = wezterm.action.ActivateTab(i),
	})
end

config.hide_tab_bar_if_only_one_tab = false
config.tab_bar_at_bottom = true
config.use_fancy_tab_bar = false
config.tab_and_split_indices_are_zero_based = true

{{ if eq .chezmoi.os "darwin" -}}
config.enable_wayland = false
{{ end -}}

-- tmux status
wezterm.on("update-right-status", function(window, _)
	local SOLID_LEFT_ARROW = ""
	local ARROW_FORGROUND = { Foreground = { Color = "#c6a0f6" } }
	local prefix = ""

	if window:leader_is_active() then
		prefix = " " .. utf8.char(0x1f30a) -- ocean wave
		SOLID_LEFT_ARROW = utf8.char(0xe0b2)
	end

	if window:active_tab():tab_id() ~= 0 then
		ARROW_FORGROUND = { Foreground = { Color = "#1e2030 " } }
	end

	window:set_left_status(wezterm.format({
		{ Background = { Color = "#b7bdf8" } },
		{ Text = prefix },
		ARROW_FORGROUND,
		{ Text = SOLID_LEFT_ARROW },
	}))
end)

-- and finally, return the configuration to wezterm
return config
