#Linux set sudo path to user path
#https://stackoverflow.com/questions/12996397/command-not-found-when-using-sudo
alias mudo='sudo -E env "PATH=$PATH"'

alias copyq='flatpak run com.github.hluk.copyq'
alias flatseal='flatpak run com.github.tchx84.Flatseal'
alias flameshot='env QT_SCREEN_SCALE_FACTORS="1;1.5;" flatpak run org.flameshot.Flameshot gui'
alias upgradedistrobox='curl -s https://raw.githubusercontent.com/89luca89/distrobox/main/install | sudo sh -s -- --next'
alias flake='nvim ~/.config/nix-darwin/'
alias msbuild='$HOME/.local/share/mise/shims/dotnet'
alias MSBuild='$HOME/.local/share/mise/shims/dotnet'

#bitwarden
alias bw_unlock='export BW_SESSION=$(bw unlock --raw)'

#git
alias lz="lazygit"

#Php
alias sail='[ -f sail ] && bash sail || bash vendor/bin/sail'

# Python
alias py="python3"
#alias python="python3"

# Vim
alias vd="nvim -d"
alias nv="nvim"
alias sv="sudo nvim"
alias v="nvim"
alias zj="zellij"
alias zjn="zellij -s"

alias l="eza"

alias wiki="nvim ~/vimwiki/index.md"

alias litellm_up="docker compose -f ~/docker/litellm/docker-compose.yml up -d"
alias litellm_down="docker compose -f ~/docker/litellm/docker-compose.yml down"

# Define path to the driver
DRIVER_PATH="/Library/Application Support/org.pqrs/Karabiner-DriverKit-VirtualHIDDevice/Applications/Karabiner-VirtualHIDDevice-Daemon.app/Contents/MacOS/Karabiner-VirtualHIDDevice-Daemon"

# --- Start Kanata + Virtual HID daemon ---
function kanata_up() {
    # 1. Refresh sudo credentials upfront
    if ! sudo -v; then
        echo "Sudo authentication failed."
        return 1
    fi

    echo "--- Starting Stack ---"

    # 2. Start the Karabiner Driver (Backgrounded)
    if pgrep -f "Karabiner-VirtualHIDDevice-Daemon" >/dev/null; then
        echo "Driver process is already running."
    else
        echo "Launching Karabiner Driver..."
        sudo nohup "$DRIVER_PATH" > /tmp/karabiner_driver.log 2>&1 &
        echo $! | sudo tee /tmp/karabiner_driver.pid >/dev/null
    fi

    # 3. SAFETY CHECK: Wait for Kernel Registration
    # We poll the I/O Registry to ensure the driver is truly ready to accept input.
    # This prevents the race condition that causes system crashes.
    echo "Waiting for driver to initialize..."
    local counter=0
    local max_retries=20 # Wait up to 10 seconds (20 * 0.5s)

    while ! ioreg -l | grep -q "Karabiner-DriverKit-VirtualHIDDevice"; do
        sleep 0.5
        ((counter++))
        
        if [ $counter -ge $max_retries ]; then
            echo "âŒ CRITICAL ERROR: Driver failed to register with Kernel."
            echo "Aborting Kanata launch to prevent system crash."
            return 1
        fi
        echo -n "."
    done
    echo "" # New line
    echo "âœ… Driver is active in Kernel."

    # 4. Start Kanata (Safe to start now)
    echo "Launching Kanata..."
    sudo nohup kanata --cfg "$HOME/.config/kanata/config.kbd" \
        >> /tmp/kanata.log 2>&1 &
    echo $! | sudo tee /tmp/kanata.pid >/dev/null

    echo "ðŸš€ Kanata Stack Started Successfully!"
}

# --- Stop Kanata AND the Driver ---
function kanata_down() {
    echo "--- Stopping Stack ---"

    # 1. Kill Kanata
    if pgrep -x "kanata" >/dev/null; then
        echo "Stopping Kanata..."
        sudo pkill -x kanata
    else
        echo "Kanata was not running."
    fi

    # 2. Kill the Driver
    if pgrep -f "Karabiner-VirtualHIDDevice-Daemon" >/dev/null; then
        echo "Stopping Karabiner Driver..."
        sudo pkill -f "Karabiner-VirtualHIDDevice-Daemon"
    else
        echo "Driver was not running."
    fi

    # 3. Clean up PID files
    sudo rm -f /tmp/kanata.pid /tmp/karabiner_driver.pid

    echo "ðŸ›‘ Stack stopped."
}

# --- Check status ---
function kanata_status() {
    echo "--- Status ---"
    
    if pgrep -x "kanata" >/dev/null; then
        echo "ðŸŸ¢ Kanata: RUNNING (PID: $(pgrep -x kanata))"
    else
        echo "ðŸ”´ Kanata: STOPPED"
    fi

    # Check process AND Kernel status
    if pgrep -f "Karabiner-VirtualHIDDevice-Daemon" >/dev/null; then
        if ioreg -l | grep -q "Karabiner-DriverKit-VirtualHIDDevice"; then
             echo "ðŸŸ¢ Driver: RUNNING & LINKED (Ready)"
        else
             echo "YA Driver: RUNNING (But not linked to Kernel yet)"
        fi
    else
        echo "ðŸ”´ Driver: STOPPED"
    fi
}

function darwin_upgrade() {
    cd ~/.config/nix-darwin/
    nix flake update
    cd -
}

function darwin_update() {
  echo "Building system configuration as unprivileged user..."
  nix build ~/.config/nix-darwin#darwinConfigurations.mchip.system

  if [ $? -eq 0 ]; then
    # this step doesn't need the full path darwinConfigurations.mchip.system
    # similarly the darwin-rebuild command looks up the systemconfiguration on its own.

    echo "Build successful. Switching system configuration as root..."
    sudo darwin-rebuild switch --flake ~/.config/nix-darwin#mchip
  else
    echo "Nix build failed. Aborting switch."
  fi
}

function cht() {
# :list
# :learn
# sub topic
    if [ -z "$1" ]; then
        lang=$(curl -s cht.sh/:list | fzf)
    else
        lang="$1"
    fi

    [ -z "$lang" ] && return

    topic=$(
      {
        echo "ALL"
        curl -s "cht.sh/$lang/:list"
      } | fzf
    )

    [ -z "$topic" ] && return

    if [[ "$topic" == "ALL" ]]; then
      curl -s "cht.sh/$lang" | bat
    else
      curl -s "cht.sh/$lang/$topic" | bat
    fi
}
